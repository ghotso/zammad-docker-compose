version: "3.8"

services:

  zammad-postgresql:
    image: postgres:17.7-alpine
    container_name: zammad_postgresql
    restart: always
    environment:
      POSTGRES_DB: zammad_production
      POSTGRES_USER: zammad
      POSTGRES_PASSWORD: zammad
    volumes:
      - /mnt/user/appdata/zammad/postgresql:/var/lib/postgresql/data

  zammad-redis:
    image: redis:7.4.7-alpine
    container_name: zammad_redis
    restart: always
    volumes:
      - /mnt/user/appdata/zammad/redis:/data

  zammad-memcached:
    image: memcached:1.6.39-alpine
    container_name: zammad_memcached
    restart: always
    command: memcached -m 256M

  zammad-elasticsearch:
    image: elasticsearch:8.19.8
    container_name: zammad_elasticsearch
    restart: always
    environment:
      discovery.type: single-node
      xpack.security.enabled: "false"
      ES_JAVA_OPTS: "-Xms1g -Xmx1g"
    volumes:
      - /mnt/user/appdata/zammad/elasticsearch:/usr/share/elasticsearch/data

  zammad-init:
    image: ghcr.io/zammad/zammad:6.5.2-46
    container_name: zammad_init
    restart: on-failure
    user: "0:0"
    command: ["zammad-init"]
    environment:
      MEMCACHE_SERVERS: zammad-memcached:11211
      POSTGRESQL_DB: zammad_production
      POSTGRESQL_HOST: zammad-postgresql
      POSTGRESQL_USER: zammad
      POSTGRESQL_PASS: zammad
      POSTGRESQL_PORT: 5432
      POSTGRESQL_OPTIONS: "?pool=50"
      REDIS_URL: redis://zammad-redis:6379
      ELASTICSEARCH_ENABLED: "true"
      ELASTICSEARCH_HOST: zammad-elasticsearch
      ELASTICSEARCH_PORT: 9200
      TZ: Europe/Berlin
    depends_on:
      - zammad-postgresql
      - zammad-redis
      - zammad-memcached
      - zammad-elasticsearch
    volumes:
      - /mnt/user/appdata/zammad/storage:/opt/zammad/storage

  zammad-railsserver:
    image: ghcr.io/zammad/zammad:6.5.2-46
    container_name: zammad_railsserver
    restart: always
    command: ["zammad-railsserver"]
    environment:
      MEMCACHE_SERVERS: zammad-memcached:11211
      POSTGRESQL_DB: zammad_production
      POSTGRESQL_HOST: zammad-postgresql
      POSTGRESQL_USER: zammad
      POSTGRESQL_PASS: zammad
      POSTGRESQL_PORT: 5432
      REDIS_URL: redis://zammad-redis:6379
      ELASTICSEARCH_ENABLED: "true"
      ELASTICSEARCH_HOST: zammad-elasticsearch
      ELASTICSEARCH_PORT: 9200
      TZ: Europe/Berlin
    volumes:
      - /mnt/user/appdata/zammad/storage:/opt/zammad/storage
    depends_on:
      - zammad-init

  zammad-nginx:
    image: ghcr.io/zammad/zammad:6.5.2-46
    container_name: zammad_nginx
    restart: always
    command: ["zammad-nginx"]
    ports:
      - "2694:8080"
    environment:
      NGINX_PORT: 8080
      TZ: Europe/Berlin
    volumes:
      - /mnt/user/appdata/zammad/storage:/opt/zammad/storage
    depends_on:
      - zammad-railsserver

  zammad-scheduler:
    image: ghcr.io/zammad/zammad:6.5.2-46
    container_name: zammad_scheduler
    restart: always
    command: ["zammad-scheduler"]
    environment:
      MEMCACHE_SERVERS: zammad-memcached:11211
      POSTGRESQL_DB: zammad_production
      POSTGRESQL_HOST: zammad-postgresql
      POSTGRESQL_USER: zammad
      POSTGRESQL_PASS: zammad
      POSTGRESQL_PORT: 5432
      REDIS_URL: redis://zammad-redis:6379
      TZ: Europe/Berlin
    volumes:
      - /mnt/user/appdata/zammad/storage:/opt/zammad/storage

  zammad-websocket:
    image: ghcr.io/zammad/zammad:6.5.2-46
    container_name: zammad_websocket
    restart: always
    command: ["zammad-websocket"]
    environment:
      MEMCACHE_SERVERS: zammad-memcached:11211
      POSTGRESQL_DB: zammad_production
      POSTGRESQL_HOST: zammad-postgresql
      POSTGRESQL_USER: zammad
      POSTGRESQL_PASS: zammad
      POSTGRESQL_PORT: 5432
      REDIS_URL: redis://zammad-redis:6379
      TZ: Europe/Berlin
    volumes:
      - /mnt/user/appdata/zammad/storage:/opt/zammad/storage

  zammad-backup:
    image: ghcr.io/zammad/zammad:6.5.2-46
    container_name: zammad_backup
    restart: always
    user: "0:0"
    command: ["zammad-backup"]
    environment:
      BACKUP_DIR: /var/tmp/zammad
      BACKUP_TIME: "03:00"
      HOLD_DAYS: "10"
      TZ: Europe/Berlin
    volumes:
      - /mnt/user/appdata/zammad/backup:/var/tmp/zammad
      - /mnt/user/appdata/zammad/storage:/opt/zammad/storage:ro
